// Generated by CoffeeScript 1.3.1
var bcrypt, checkPassword, crypto, db, line, registrationTemplate, requireUser, soma, wings, _ref;

bcrypt = require('bcrypt');

crypto = require('crypto');

line = require('line');

soma = require('soma');

wings = require('wings');

db = require('../lib/db');

_ref = require('./lib/decorators'), checkPassword = _ref.checkPassword, requireUser = _ref.requireUser;

registrationTemplate = "{name}, \n\nWe just wanted to welcome you to Min.gl\n\nHope you enjoy it and meet some cool people.\n\nReally that's all we wanted to say. \n\nIf you have any questions, let us know.\n\nBest,\n    The Min.gl Team";

soma.routes({
  '/api/login': checkPassword(function() {
    var _this = this;
    line(function() {
      return db.get('users', _this.login.user, line.wait());
    });
    line(function(user) {
      var userCookie;
      _this.user = user;
      return userCookie = _this.jar.get('user');
    });
    line(function() {
      return crypto.randomBytes(16, line.wait());
    });
    line(function(session) {
      return db.update('users', _this.user.id, {
        session: session.toString('hex')
      }, line.wait());
    });
    return line.run(function(user) {
      _this.user = user;
      _this.jar.set('user', JSON.stringify(_this.user), {
        signed: true,
        httpOnly: false
      });
      return _this.send();
    });
  })
});
