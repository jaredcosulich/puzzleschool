// Generated by CoffeeScript 1.3.1
var db, line, requireUser, soma,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

line = require('line');

soma = require('soma');

db = require('../lib/db');

requireUser = require('./lib/decorators').requireUser;

soma.routes({
  '/api/puzzles/:puzzleName': requireUser(function(puzzleName) {
    var _this = this;
    line(function() {
      return db.get('user_puzzles', "" + _this.user.id + "/" + puzzleName, line.wait());
    });
    line(function(userPuzzle) {
      _this.userPuzzle = userPuzzle;
      if (!_this.userPuzzle) {
        _this.send({});
        line.end();
      }
    });
    line(function() {
      return db.multiget('user_puzzle_progress', _this.userPuzzle.levelsPlayed, line.wait());
    });
    line(function(data) {
      var level, _i, _len, _ref;
      _this.userPuzzle.levels = {};
      _ref = data.user_puzzle_progress;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        level = _ref[_i];
        _this.userPuzzle.levels[level.name] = level;
      }
      return delete _this.userPuzzle.levelsPlayed;
    });
    line.error(function(err) {
      return _this.sendError(err, 'Puzzle Info Failed');
    });
    return line.run(function() {
      return _this.send({
        puzzle: _this.userPuzzle
      });
    });
  }),
  '/api/puzzles/:puzzleName/update': requireUser(function(puzzleName) {
    var levelName, levelUpdate, levelsPlayedUpdates, updates, userPuzzle, _ref,
      _this = this;
    console.log(this.data);
    userPuzzle = "" + this.user.id + "/" + puzzleName;
    if (__indexOf.call(this.user.user_puzzles || [], userPuzzle) < 0) {
      line(function() {
        return db.update('users', _this.user.id, {
          user_puzzles: {
            add: [userPuzzle]
          }
        }, line.wait());
      });
    }
    if (this.data.puzzleUpdates) {
      levelsPlayedUpdates = (function() {
        var _ref, _results;
        _ref = this.data.levelUpdates;
        _results = [];
        for (levelName in _ref) {
          updates = _ref[levelName];
          _results.push("" + userPuzzle + "/" + levelName);
        }
        return _results;
      }).call(this);
      if (levelsPlayedUpdates.length) {
        this.data.puzzleUpdates.levelsPlayed = {
          add: levelsPlayedUpdates
        };
      }
      line(function() {
        return db.update('user_puzzles', userPuzzle, _this.data.puzzleUpdates, line.wait());
      });
    }
    if (this.data.levelUpdates) {
      _ref = this.data.levelUpdates;
      for (levelName in _ref) {
        levelUpdate = _ref[levelName];
        levelUpdate.name = levelName;
        line(function() {
          return db.update('user_puzzle_progress', "" + userPuzzle + "/" + levelName, levelUpdate, line.wait());
        });
      }
    }
    line.error(function(err) {
      return _this.sendError(err, 'Puzzle Update Failed');
    });
    return line.run(function() {
      return _this.send();
    });
  })
});
