// Generated by CoffeeScript 1.3.3
var soma, sortLevels, wings;

soma = require('soma');

wings = require('wings');

sortLevels = function(levels) {
  return levels.sort(function(level1, level2) {
    var a, b;
    a = level1.difficulty + level1.name;
    b = level2.difficulty + level2.name;
    if (a === b) {
      return 0;
    } else {
      if (a < b) {
        return -1;
      } else {
        return 1;
      }
    }
  });
};

soma.chunks({
  Class: {
    meta: function() {
      return new soma.chunks.Base({
        content: this
      });
    },
    prepare: function(_arg) {
      var _this = this;
      this.id = _arg.id;
      this.template = this.loadTemplate('/build/common/templates/class.html');
      if (this.id) {
        return this.loadData({
          url: "/api/classes/info/" + this.id,
          success: function(data) {
            var level, _i, _len, _ref;
            _this.classInfo = data;
            _ref = _this.classInfo.levels || [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              level = _ref[_i];
              level.classId = _this.classInfo.id;
            }
            return _this.classInfo.levels = sortLevels(_this.classInfo.levels);
          },
          error: function() {
            if (typeof window !== "undefined" && window !== null ? window.alert : void 0) {
              return alert('We were unable to load the information for this class. Please check your internet connection.');
            }
          }
        });
      }
    },
    build: function() {
      var l, _ref, _ref1;
      this.setTitle("Your Class - The Puzzle School");
      return this.html = wings.renderTemplate(this.template, {
        id: (_ref = this.classInfo) != null ? _ref.id : void 0,
        className: ((_ref1 = this.classInfo) != null ? _ref1.name : void 0) || 'New Class',
        newClass: !(this.classInfo != null),
        fractions_levels: (function() {
          var _i, _len, _ref2, _ref3, _results;
          _ref3 = (_ref2 = this.classInfo) != null ? _ref2.levels : void 0;
          _results = [];
          for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
            l = _ref3[_i];
            if (l.puzzle === 'fractions') {
              _results.push(l);
            }
          }
          return _results;
        }).call(this),
        xyflyer_levels: (function() {
          var _i, _len, _ref2, _ref3, _results;
          _ref3 = (_ref2 = this.classInfo) != null ? _ref2.levels : void 0;
          _results = [];
          for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
            l = _ref3[_i];
            if (l.puzzle === 'xyflyer') {
              _results.push(l);
            }
          }
          return _results;
        }).call(this)
      });
    }
  }
});

soma.views({
  Class: {
    selector: '#content .class',
    create: function() {
      var _this = this;
      $('.register_flag').hide();
      this.$('form').bind('submit', function(e) {
        return e.stop();
      });
      this.$('button').bind('click', function(e) {
        return e.stop();
      });
      this.classInfo = {
        id: this.el.data('id')
      };
      this.initSaveClass();
      return this.initAddALevel();
    },
    initSaveClass: function() {
      var _this = this;
      this.$('.class_update').bind('submit', function() {
        return _this.saveClass();
      });
      this.$('.save_button').bind('click', function() {
        return _this.saveClass();
      });
      return this.$('.cancel_button').bind('click', function() {
        return _this.go('/');
      });
    },
    saveClass: function() {
      var dataHash,
        _this = this;
      dataHash = this.$('.class_update').data('form').dataHash();
      dataHash.id = this.el.data('id');
      return $.ajaj({
        url: '/api/classes/update',
        method: 'POST',
        headers: {
          'X-CSRF-Token': this.cookies.get('_csrf', {
            raw: true
          })
        },
        data: dataHash,
        success: function(classInfo) {
          return _this.go("/class/" + classInfo.id);
        }
      });
    },
    initAddALevel: function() {
      var _this = this;
      this.puzzles = {
        fractions: {
          levels: []
        },
        xyflyer: {
          levels: []
        }
      };
      this.$('.add_a_level').bind('click', function(e) {
        return _this.displayLevelSelector($(e.currentTarget).data('puzzle'));
      });
      this.$('.create_level').bind('click', function(e) {
        return _this.showNewLevelForm($(e.currentTarget).closest('.level_selector').find('.new_level'));
      });
      this.$('.save_new_level_button').bind('click', function(e) {
        return _this.addNewLevel($(e.currentTarget).closest('.new_level'));
      });
      return this.$('.cancel_new_level_button').bind('click', function(e) {
        return _this.hideNewLevelForm($(e.currentTarget).closest('.new_level'));
      });
    },
    displayLevels: function(puzzle, area) {
      var level, levelNameComponents, puzzleName, tableHtml, _i, _len, _ref;
      puzzleName = puzzle;
      if (puzzleName === 'fractions') {
        puzzleName = 'light_it_up';
      }
      area.html('');
      tableHtml = '<table>\n    <tbody>\n        <th>Name</th>\n        <th>Difficulty</th>\n        <th>Select</th>';
      _ref = sortLevels(this.puzzles[puzzle].levels);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        level = _ref[_i];
        levelNameComponents = level.id.split(/\//g);
        tableHtml += "<tr>\n    <td>\n        <a href='/puzzles/" + puzzleName + "/" + level.id + "' target='_blank'>\n            " + level.name + "\n        </a>\n    </td>\n    <td>\n        " + level.difficulty + "\n    </td>\n    <td>\n        <a class='select_level' data-level=\"" + level.id + "\">\n            Select\n        </a>\n    </td>\n</tr>";
      }
      tableHtml += '</tbody></table>';
      area.html(tableHtml);
      return this.bindLevelLinks();
    },
    bindLevelLinks: function() {
      var _this = this;
      this.$('.select_level').unbind('click');
      return this.$('.select_level').bind('click', function(e) {
        return _this.selectLevel($(e.currentTarget).data('level'));
      });
    },
    showNewLevelForm: function(newLevel) {
      newLevel.css({
        display: 'block'
      });
      return newLevel.animate({
        opacity: 1,
        duration: 250
      });
    },
    hideNewLevelForm: function(newLevel) {
      return newLevel.animate({
        opacity: 0,
        duration: 250,
        complete: function() {
          return newLevel.css({
            display: 'none'
          });
        }
      });
    },
    selectLevel: function(levelId) {
      var _this = this;
      return $.ajaj({
        url: "/api/classes/levels/add/" + this.classInfo.id,
        method: 'POST',
        headers: {
          'X-CSRF-Token': this.cookies.get('_csrf', {
            raw: true
          })
        },
        data: {
          level: levelId
        },
        success: function(classLevels) {
          var level, levelsListHtml, _i, _len, _ref;
          levelsListHtml = '';
          _ref = sortLevels(classLevels.levels);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            level = _ref[_i];
            console.log(level);
            levelsListHtml += "<li><a href='/puzzles/" + level.puzzle + "/" + _this.classInfo.id + "/{level.id}' target='_blank'>\n    " + level.name + "\n</a></li>";
          }
          _this.$(".class_puzzles ." + puzzle).html(levelsListHtml);
          return _this.hideLevelSelector();
        }
      });
    },
    addNewLevel: function(newLevelContainer) {
      var dataHash, puzzle,
        _this = this;
      puzzle = newLevelContainer.data('puzzle').toLowerCase();
      dataHash = newLevelContainer.find('form').data('form').dataHash();
      dataHash.classId = this.classInfo.id;
      return $.ajaj({
        url: "/api/puzzles/" + puzzle + "/add_level",
        method: 'POST',
        headers: {
          'X-CSRF-Token': this.cookies.get('_csrf', {
            raw: true
          })
        },
        data: dataHash,
        success: function(levelInfo) {
          _this.puzzles[puzzle].levels.push(levelInfo);
          _this.displayLevels(puzzle, newLevelContainer.closest('.level_selector').find('.levels'));
          return _this.hideNewLevelForm(newLevelContainer);
        }
      });
    },
    displayLevelSelector: function(puzzle) {
      var levelSelector, lowerPuzzle,
        _this = this;
      this.$('.puzzle_name').html(puzzle);
      levelSelector = this.$('.level_selector');
      levelSelector.find('.new_level').data('puzzle', puzzle);
      levelSelector.css({
        opacity: 0,
        top: ($.viewport().height / 2) - (levelSelector.height() / 2) + window.scrollY,
        left: ($.viewport().width / 2) - (levelSelector.width() / 2)
      });
      levelSelector.animate({
        opacity: 1,
        duration: 250
      });
      levelSelector.bind('click.level_selector', function(e) {
        return e.stop();
      });
      $.timeout(10, function() {
        return $(document.body).one('click.level_selector', function() {
          return levelSelector.animate({
            opacity: 1,
            duration: 250,
            complete: function() {
              return levelSelector.css({
                opacity: 0,
                top: -1000,
                left: -1000
              });
            }
          });
        });
      });
      lowerPuzzle = puzzle.toLowerCase();
      return $.ajaj({
        url: "/api/puzzles/" + lowerPuzzle + "/levels",
        method: 'GET',
        headers: {
          'X-CSRF-Token': this.cookies.get('_csrf', {
            raw: true
          })
        },
        success: function(levelData) {
          _this.puzzles[lowerPuzzle].levels = levelData.levels || [];
          return _this.displayLevels(lowerPuzzle, levelSelector.find('.levels'));
        },
        error: function() {
          return levelSelector.find('.levels').html('No levels yet');
        }
      });
    },
    hideLevelSelector: function() {
      var levelSelector,
        _this = this;
      levelSelector = this.$('.level_selector');
      return levelSelector.animate({
        opacity: 0,
        duration: 250,
        complete: function() {
          return levelSelector.css({
            top: -1000,
            left: -1000
          });
        }
      });
    }
  }
});

soma.routes({
  '/class': function() {
    return new soma.chunks.Class;
  },
  '/class/:id': function(_arg) {
    var id;
    id = _arg.id;
    return new soma.chunks.Class({
      id: id
    });
  }
});
