// Generated by CoffeeScript 1.3.3
var gravity;

gravity = typeof exports !== "undefined" && exports !== null ? exports : provide('./lib/gravity', {});

gravity.ViewHelper = (function() {

  function ViewHelper(_arg) {
    this.el = _arg.el;
    this.wells = [];
    this.asteroids = [];
    this.initGravityWells();
    this.initAsteroids();
    this.initGoal();
    this.lastStep = new Date();
    this.step();
  }

  ViewHelper.prototype.$ = function(selector) {
    return $(selector, this.el);
  };

  ViewHelper.prototype.initGoal = function() {
    return this.goal = new gravity.Goal(this.el, 800, 300);
  };

  ViewHelper.prototype.initAsteroids = function() {
    return this.asteroids.push(new gravity.Asteroid(this.el, 100, 100));
  };

  ViewHelper.prototype.initGravityWells = function() {
    var _this = this;
    return this.el.bind('mousedown.well', function(e) {
      var well;
      well = new gravity.Well(_this.el, e.offsetX, e.offsetY);
      well.grow();
      _this.el.bind('mouseup.well', function(e) {
        return well.shrink();
      });
      return _this.wells.push(well);
    });
  };

  ViewHelper.prototype.step = function() {
    var asteroid, well, _i, _j, _len, _len1, _ref, _ref1,
      _this = this;
    _ref = this.wells;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      well = _ref[_i];
      if (!(!well.deleted)) {
        continue;
      }
      well.modify();
      well.affect(this.asteroids);
    }
    _ref1 = this.asteroids;
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      asteroid = _ref1[_j];
      asteroid.move(new Date() - this.lastStep);
      if (this.goal.touching(asteroid)) {
        console.log('touch');
      }
    }
    this.lastStep = new Date();
    return setTimeout((function() {
      return _this.step();
    }), 10);
  };

  return ViewHelper;

})();

gravity.Well = (function() {

  Well.prototype.MAX_RADIUS = 25;

  Well.prototype.MASS_RATIO = 10;

  Well.prototype.GRAVITATIONAL_CONSTANT = 6.67 * Math.pow(10, -1);

  function Well(container, x, y) {
    this.container = container;
    this.x = x;
    this.y = y;
    this.el = $(document.createElement('DIV'));
    this.el.addClass('well');
    this.el.css({
      left: this.x,
      top: this.y
    });
    this.radius = 0;
    this.container.append(this.el);
  }

  Well.prototype["delete"] = function() {
    this.el.remove();
    return this.deleted = true;
  };

  Well.prototype.grow = function() {
    return this.rate = 1;
  };

  Well.prototype.shrink = function() {
    return this.rate = -1;
  };

  Well.prototype.stop = function() {
    return delete this.rate;
  };

  Well.prototype.modify = function() {
    if (this.rate == null) {
      return;
    }
    this.radius += this.rate;
    if (this.radius > this.MAX_RADIUS) {
      this.stop();
      return;
    }
    if (this.radius < 0) {
      this["delete"]();
    }
    return this.el.css({
      boxShadow: "0px 0 " + (this.radius * 2) + "px " + this.radius + "px rgba(255,255,255,0.8)"
    });
  };

  Well.prototype.affect = function(asteroids) {
    var asteroid, distance, force, xForce, yForce, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = asteroids.length; _i < _len; _i++) {
      asteroid = asteroids[_i];
      distance = Math.sqrt(Math.pow(this.x - asteroid.x, 2) + Math.pow(this.y - asteroid.y, 2));
      force = (this.GRAVITATIONAL_CONSTANT * asteroid.mass * (this.MASS_RATIO * this.radius)) / Math.pow(distance, 2);
      xForce = (this.x - asteroid.x) * (force / distance);
      yForce = (this.y - asteroid.y) * (force / distance);
      _results.push(asteroid.changeSpeed(xForce / asteroid.mass, yForce / asteroid.mass));
    }
    return _results;
  };

  return Well;

})();

gravity.Asteroid = (function() {

  Asteroid.prototype.MAX_SPEED = 1;

  function Asteroid(container, x, y) {
    this.container = container;
    this.x = x;
    this.y = y;
    this.mass = 10;
    this.xSpeed = 0;
    this.ySpeed = -0.25;
    this.el = $(document.createElement('DIV'));
    this.el.addClass('asteroid');
    this.container.append(this.el);
    this.move(1);
  }

  Asteroid.prototype.left = function() {
    return this.x - (this.el.width() / 2);
  };

  Asteroid.prototype.right = function() {
    return this.x + (this.el.width() / 2);
  };

  Asteroid.prototype.top = function() {
    return this.y - (this.el.height() / 2);
  };

  Asteroid.prototype.bottom = function() {
    return this.y + (this.el.height() / 2);
  };

  Asteroid.prototype.changeSpeed = function(xDiff, yDiff) {
    this.xSpeed += xDiff;
    this.ySpeed += yDiff;
    if (this.xSpeed > this.MAX_SPEED) {
      this.xSpeed = this.MAX_SPEED;
    }
    if (this.ySpeed > this.MAX_SPEED) {
      this.ySpeed = this.MAX_SPEED;
    }
    if (this.xSpeed < this.MAX_SPEED * -1) {
      this.xSpeed = this.MAX_SPEED * -1;
    }
    if (this.ySpeed < this.MAX_SPEED * -1) {
      return this.ySpeed = this.MAX_SPEED * -1;
    }
  };

  Asteroid.prototype.move = function(time) {
    this.x += this.xSpeed * time;
    this.y += this.ySpeed * time;
    if (this.x > this.container.width()) {
      this.x = 0;
    }
    if (this.x < 0) {
      this.x = this.container.width();
    }
    if (this.y > this.container.height()) {
      this.y = 0;
    }
    if (this.y < 0) {
      this.y = this.container.height();
    }
    return this.el.css({
      left: this.x,
      top: this.y
    });
  };

  return Asteroid;

})();

gravity.Goal = (function() {

  function Goal(container, x, y) {
    this.container = container;
    this.x = x;
    this.y = y;
    this.el = $(document.createElement('DIV'));
    this.el.addClass('goal');
    this.el.css({
      left: this.x,
      top: this.y
    });
    this.container.append(this.el);
  }

  Goal.prototype.left = function() {
    return this.x - (this.el.width() / 2);
  };

  Goal.prototype.right = function() {
    return this.x + (this.el.width() / 2);
  };

  Goal.prototype.top = function() {
    return this.y - (this.el.height() / 2);
  };

  Goal.prototype.bottom = function() {
    return this.y + (this.el.height() / 2);
  };

  Goal.prototype.touching = function(asteroid) {
    var _ref, _ref1, _ref2, _ref3, _ref4, _ref5;
    if ((((this.left() < (_ref = asteroid.left()) && _ref < this.right())) || ((this.left() < (_ref1 = asteroid.right()) && _ref1 < this.right())) || ((this.left() < (_ref2 = asteroid.x) && _ref2 < this.right()))) && (((this.top() < (_ref3 = asteroid.top()) && _ref3 < this.bottom())) || ((this.top() < (_ref4 = asteroid.bottom()) && _ref4 < this.bottom())) || ((this.top() < (_ref5 = asteroid.y) && _ref5 < this.bottom())))) {
      return true;
    }
    return false;
  };

  return Goal;

})();
