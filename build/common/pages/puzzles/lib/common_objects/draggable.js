// Generated by CoffeeScript 1.3.3
var Client, Transformer, draggable;

draggable = typeof exports !== "undefined" && exports !== null ? exports : provide('../common_objects/draggable', {});

Transformer = require('../common_objects/transformer').Transformer;

Client = require('../common_objects/client').Client;

draggable.Draggable = (function() {

  function Draggable() {}

  Draggable.prototype.initDrag = function(dragElement, trackDrag, center, buffer) {
    this.dragElement = dragElement;
    this.trackDrag = trackDrag;
    this.center = center;
    this.buffer = buffer;
    this.transformer = new Transformer(this.dragElement);
    return this.bindDrag();
  };

  Draggable.prototype.bindDrag = function() {
    var _this = this;
    return this.dragElement.bind('mousedown.drag touchstart.drag', function(e) {
      return _this.startDrag(e);
    });
  };

  Draggable.prototype.unbindDrag = function() {
    return this.dragElement.unbind('mousedown.drag touchstart.drag');
  };

  Draggable.prototype.setStartDrag = function(e) {
    var offset;
    if (this.center) {
      offset = this.dragElement.offset();
      this.startX = offset.left + (offset.width / 2);
      return this.startY = offset.top + (offset.height / 2);
    } else {
      if (!this.startX) {
        this.startX = Client.x(e);
      }
      if (!this.startY) {
        return this.startY = Client.y(e);
      }
    }
  };

  Draggable.prototype.startDrag = function(e) {
    var bottomBuffer, leftBuffer, offset, rightBuffer, shiftX, shiftY, topBuffer, _ref, _ref1, _ref2, _ref3, _ref4, _ref5,
      _this = this;
    leftBuffer = ((_ref = this.buffer) != null ? _ref.left : void 0) || 0;
    rightBuffer = ((_ref1 = this.buffer) != null ? _ref1.right : void 0) || 0;
    topBuffer = ((_ref2 = this.buffer) != null ? _ref2.top : void 0) || 0;
    bottomBuffer = ((_ref3 = this.buffer) != null ? _ref3.bottom : void 0) || 0;
    offset = this.dragElement.offset();
    shiftX = this.currentX ? this.currentX - this.startX : 0;
    shiftY = this.currentY ? this.currentY - this.startY : 0;
    if (!((offset.left + leftBuffer < (_ref4 = Client.x(e) - shiftX) && _ref4 < offset.left + offset.width - rightBuffer)) || !((offset.top + topBuffer < (_ref5 = Client.y(e) - shiftY) && _ref5 < offset.top + offset.height - bottomBuffer))) {
      return false;
    }
    e.stop();
    $(document.body).one('mouseup.drag touchend.drag', function(e) {
      $(document.body).unbind('mousemove.drag touchstart.drag');
      return _this.drag(e, 'stop');
    });
    this.setStartDrag(e);
    this.drag(e, 'start');
    $(document.body).bind('mousemove.drag touchmove.drag', function(e) {
      _this.setStartDrag(e);
      return _this.drag(e, 'move');
    });
    return true;
  };

  Draggable.prototype.drag = function(e, state) {
    return this.dragTo({
      x: Client.x(e),
      y: Client.y(e),
      state: state
    });
  };

  Draggable.prototype.dragTo = function(_arg) {
    var state, x, y;
    x = _arg.x, y = _arg.y, state = _arg.state;
    this.currentX = x;
    this.currentY = y;
    this.transformer.translate(this.currentX - this.startX, this.currentY - this.startY);
    return this.trackDrag(this, this.currentX, this.currentY, state);
  };

  Draggable.prototype.resetDrag = function() {
    delete this.startX;
    delete this.startY;
    delete this.currentX;
    delete this.currentY;
    return this.transformer.translate(0, 0);
  };

  return Draggable;

})();
