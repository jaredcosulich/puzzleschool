// Generated by CoffeeScript 1.3.3
var Client, board, circuitousObject,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

board = typeof exports !== "undefined" && exports !== null ? exports : provide('./board', {});

circuitousObject = require('./object');

Client = require('../common_objects/client').Client;

board.Board = (function(_super) {

  __extends(Board, _super);

  Board.prototype.cellDimension = 32;

  function Board(_arg) {
    this.el = _arg.el;
    this.items = [];
    this.init();
  }

  Board.prototype.init = function() {
    this.width = this.el.width();
    this.height = this.el.height();
    this.drawGrid();
    return this.initWire();
  };

  Board.prototype.drawGrid = function() {
    var cell, column, columns, row, rows, _i, _results;
    rows = this.height / this.cellDimension;
    columns = this.width / this.cellDimension;
    _results = [];
    for (row = _i = 1; 1 <= rows ? _i <= rows : _i >= rows; row = 1 <= rows ? ++_i : --_i) {
      _results.push((function() {
        var _j, _results1;
        _results1 = [];
        for (column = _j = 1; 1 <= columns ? _j <= columns : _j >= columns; column = 1 <= columns ? ++_j : --_j) {
          cell = $(document.createElement('DIV'));
          cell.addClass('cell');
          cell.css({
            width: this.cellDimension - 1,
            height: this.cellDimension - 1
          });
          _results1.push(this.el.append(cell));
        }
        return _results1;
      }).call(this));
    }
    return _results;
  };

  Board.prototype.addItem = function(item, x, y) {
    var offset, onBoardX, onBoardY;
    offset = this.el.offset();
    onBoardX = (offset.left < x && x < offset.left + this.width);
    onBoardY = (offset.top < y && y < offset.top + this.height);
    if (onBoardX && onBoardY) {
      return this.items.push(item);
    } else {
      return false;
    }
  };

  Board.prototype.initWire = function() {
    var _this = this;
    this.wireInfo = {
      positions: {}
    };
    return this.el.bind('mousedown.draw_wire', function(e) {
      $(document.body).one('mouseup.draw_wire', function() {
        _this.el.unbind('mousemove.draw_wire');
        delete _this.wireInfo.active;
        delete _this.wireInfo.continuation;
        return delete _this.wireInfo.erasing;
      });
      _this.el.bind('mousemove.draw_wire', function(e) {
        return _this.drawActiveWire(e);
      });
      return _this.drawActiveWire(e);
    });
  };

  Board.prototype.roundedCoordinates = function(coords) {
    var halfDim, offset, offsetCoords;
    offset = this.el.offset();
    halfDim = this.cellDimension / 2;
    offsetCoords = {
      x: coords.x - offset.left + halfDim,
      y: coords.y - offset.top + halfDim
    };
    return {
      x: (Math.round(offsetCoords.x / this.cellDimension) * this.cellDimension) - halfDim,
      y: (Math.round(offsetCoords.y / this.cellDimension) * this.cellDimension) - halfDim
    };
  };

  Board.prototype.recordActiveWirePosition = function(coords) {
    var _base, _name;
    (_base = this.wireInfo.positions)[_name = coords.x] || (_base[_name] = {});
    return this.wireInfo.positions[coords.x][coords.y] = this.wireInfo.active;
  };

  Board.prototype.drawActiveWire = function(e) {
    var active, coords, xDiff, xStartDiff, yDiff, yStartDiff;
    coords = this.roundedCoordinates({
      x: Client.x(e),
      y: Client.y(e)
    });
    if (active = this.wireInfo.active) {
      xDiff = Math.abs(active.position.x - coords.x);
      yDiff = Math.abs(active.position.y - coords.y);
      if (xDiff < this.cellDimension && yDiff < this.cellDimension) {
        return;
      }
      xStartDiff = Math.abs(active.start.x - coords.x);
      yStartDiff = Math.abs(active.start.y - coords.y);
      if ((active.direction === 'horizontal' && yStartDiff - xDiff > (this.cellDimension * 0.75)) || (active.direction === 'vertical' && xStartDiff - yDiff > (this.cellDimension * 0.75))) {
        this.wireInfo.continuation = true;
        coords.x = active.position.x;
        coords.y = active.position.y;
        if (!(active.element.height() && active.element.width())) {
          active.element.remove();
        }
        delete this.wireInfo.active;
        active = null;
      }
    }
    if (!active) {
      this.createActiveWire(coords);
      return;
    }
    if (this.wireInfo.erasing) {
      return this.eraseActiveWire(coords);
    } else {
      if (!active.direction) {
        active.direction = (xDiff > yDiff ? 'horizontal' : 'vertical');
        active.element.addClass(active.direction);
      }
      return this.adjustActiveWire(coords);
    }
  };

  Board.prototype.createActiveWire = function(coords) {
    var active, _ref;
    if (!this.wireInfo.continuation && (active = this.wireInfo.active = (_ref = this.wireInfo.positions[coords.x]) != null ? _ref[coords.y] : void 0)) {
      this.wireInfo.erasing = true;
      return this.eraseActiveWire(coords);
    } else {
      active = this.wireInfo.active = {
        element: $(document.createElement('DIV')),
        position: {
          x: coords.x,
          y: coords.y
        }
      };
      this.setActiveWireStart(coords);
      active.element.addClass('wire');
      this.el.append(active.element);
      return this.recordActiveWirePosition(coords);
    }
  };

  Board.prototype.setActiveWireStart = function(coords) {
    var active;
    if (!(active = this.wireInfo.active)) {
      return;
    }
    active.start = {
      x: coords.x,
      y: coords.y
    };
    return this.positionActiveWire(coords);
  };

  Board.prototype.positionActiveWire = function(coords) {
    var active, className, left, rightOffset, top;
    if (!(active = this.wireInfo.active)) {
      return;
    }
    if (active.direction === 'horizontal') {
      rightOffset = this.el.closest('.circuitous').width() - this.width;
      left = active.start.x >= coords.x;
      className = (left ? 'left' : 'right');
    } else {
      top = active.start.y >= coords.y;
      className = (top ? 'up' : 'down');
    }
    active.element.css({
      left: (!left ? active.start.x : null),
      right: (left ? this.width - active.start.x + rightOffset : null),
      top: (!top ? active.start.y : null),
      bottom: (top ? this.height - active.start.y : null)
    });
    if (!active.element.hasClass(className)) {
      return active.element.addClass(className);
    }
  };

  Board.prototype.adjustActiveWire = function(coords) {
    var active;
    if (!(active = this.wireInfo.active)) {
      return;
    }
    this.recordActiveWirePosition(coords);
    this.positionActiveWire(coords);
    if (active.direction === 'horizontal') {
      active.element.css({
        width: Math.abs(coords.x - active.start.x)
      });
      return active.position.x = coords.x;
    } else {
      active.element.css({
        height: Math.abs(coords.y - active.start.y)
      });
      return active.position.y = coords.y;
    }
  };

  Board.prototype.splitActiveWire = function(coords) {};

  Board.prototype.eraseActiveWire = function(coords) {
    var active;
    console.log('erase', coords);
    if (!(active = this.wireInfo.active)) {
      return;
    }
    active.position = {
      x: coords.x,
      y: coords.y
    };
    if (coords.x === active.start.x && coords.y === active.start.y) {
      if (active.direction === 'horizontal') {
        active.element.width = parseInt(active.element.width() - Math.abs(coords.x - active.start.x));
      } else {
        active.element.height = parseInt(active.element.height() - Math.abs(coords.y - active.start.y));
      }
      return this.setActiveWireStart(coords);
    } else {
      return this.adjustActiveWire(coords);
    }
  };

  return Board;

})(circuitousObject.Object);
