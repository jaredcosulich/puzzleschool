// Generated by CoffeeScript 1.3.3
var neurobehavObject, oscilloscope,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

oscilloscope = typeof exports !== "undefined" && exports !== null ? exports : provide('./oscilloscope', {});

neurobehavObject = require('./object');

oscilloscope.Oscilloscope = (function(_super) {

  __extends(Oscilloscope, _super);

  Oscilloscope.prototype.objectType = 'oscilloscope';

  Oscilloscope.prototype.objectName = 'Oscilloscope';

  Oscilloscope.prototype.width = 180;

  Oscilloscope.prototype.height = 48;

  Oscilloscope.prototype.screenWidth = 150;

  Oscilloscope.prototype.screenHeight = 90;

  Oscilloscope.prototype.screenColor = '#64A539';

  Oscilloscope.prototype.xDelta = 1;

  function Oscilloscope(_arg) {
    var _this = this;
    this.board = _arg.board;
    Oscilloscope.__super__.constructor.apply(this, arguments);
    this.draw();
    this.drawThreshold();
    this.initImage();
    setInterval((function() {
      return _this.fire();
    }), this.periodicity);
  }

  Oscilloscope.prototype.init = function() {
    this.scale = this.screenHeight / 2;
    return this.xAxis = this.screenHeight - 12;
  };

  Oscilloscope.prototype.draw = function() {
    var connection, connectionLength, endX, endY, innerNeedle, needle, slope, startingX, startingY;
    this.image = this.paper.set();
    this.graph = this.paper.rect(this.position.left + (this.screenWidth / 2) - 6, this.position.top - (this.screenHeight / 2) - 6, this.screenWidth + 12, this.screenHeight + 12, 6);
    this.graph.attr({
      fill: '#ACACAD'
    });
    this.image.push(this.graph);
    startingX = this.graph.attr('x');
    startingY = this.graph.attr('y') + (this.graph.attr('height') / 2);
    this.screen = this.paper.rect(this.position.left + (this.screenWidth / 2), this.position.top - (this.screenHeight / 2), this.screenWidth, this.screenHeight, 6);
    this.screen.attr({
      fill: 'black'
    });
    this.image.push(this.screen);
    connectionLength = 20;
    slope = ((this.position.top + this.height) - startingY) / ((startingX - connectionLength) - this.position.left);
    endX = startingX - connectionLength - 10;
    endY = startingY + (slope * 10);
    connection = this.paper.path("M" + startingX + "," + startingY + "\nL" + (startingX - connectionLength) + "," + startingY + "\nL" + endX + "," + endY);
    connection.attr({
      'stroke-width': 2
    });
    this.image.push(connection);
    needle = this.paper.path("M" + (endX - 5) + "," + (endY - (5 * (1 / slope))) + "\nL" + this.position.left + ", " + (this.position.top + this.height) + "\nL" + (endX + 5) + "," + (endY + (5 * (1 / slope))) + "\nL" + (endX - 5) + "," + (endY - (5 * (1 / slope))));
    needle.attr({
      fill: 'white'
    });
    this.image.push(needle);
    innerNeedle = this.paper.path("M" + (endX - 3) + "," + (endY - (3 * (1 / slope))) + "\nL" + this.position.left + ", " + (this.position.top + this.height) + "\nL" + (endX + 3) + "," + (endY + (3 * (1 / slope))));
    innerNeedle.attr({
      stroke: '#ccc'
    });
    return this.image.push(innerNeedle);
  };

  Oscilloscope.prototype.initImage = function() {
    var fullDX, fullDY, glow, lastDX, lastDY, onDrag, onEnd, onStart,
      _this = this;
    this.image.properties = {
      description: this.description
    };
    this.image.attr({
      cursor: 'move'
    });
    glow = this.initMoveGlow(this.graph);
    this.image.toFront();
    lastDX = 0;
    lastDY = 0;
    fullDX = 0;
    fullDY = 0;
    onDrag = function(dX, dY) {
      fullDX = lastDX + dX;
      fullDY = lastDY + dY;
      _this.image.transform("t" + fullDX + "," + fullDY);
      return glow.transform("t" + fullDX + "," + fullDY);
    };
    onStart = function() {
      _this.showProperties(_this.image);
      _this.unattach();
      return glow.show();
    };
    onEnd = function() {
      var element, _i, _len, _ref, _results;
      glow.attr({
        opacity: 0
      });
      lastDX = fullDX;
      lastDY = fullDY;
      _ref = _this.paper.getElementsByPoint(_this.position.left + fullDX, (_this.position.top + _this.height) + fullDY);
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        element = _ref[_i];
        if (element.objectType === 'neuron') {
          _results.push(_this.attachTo(element.object));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };
    this.image.drag(onDrag, onStart, onEnd);
    return glow.drag(onDrag, onStart, onEnd);
  };

  Oscilloscope.prototype.screenPath = function(path) {
    var border, line, set;
    set = this.paper.set();
    border = this.paper.path(path);
    line = this.paper.path(path);
    border.attr({
      stroke: this.screenColor,
      'stroke-opacity': 0.5,
      'stroke-width': 3
    });
    line.attr({
      stroke: this.screenColor
    });
    set.push(border, line);
    this.image.push(set);
    return set;
  };

  Oscilloscope.prototype.fire = function() {
    var bbox, part, voltage, _i, _len, _ref;
    if (!this.neuron) {
      return;
    }
    voltage = this.xAxis - (this.neuron.takeReading() * this.scale);
    this.firePosition || (this.firePosition = this.screenWidth);
    bbox = this.screen.getBBox();
    if (this.firePosition >= this.screenWidth) {
      if (this.voltageDisplay) {
        this.voltageDisplay.remove();
      }
      this.firePosition = 0;
      this.voltageDisplay = this.screenPath("M" + bbox.x + ", " + (bbox.y + (this.lastVoltage || this.xAxis)));
    }
    _ref = this.voltageDisplay.items;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      part = _ref[_i];
      part.attr({
        path: "" + (part.attr('path')) + "\nL" + (bbox.x + this.firePosition) + ", " + (bbox.y + voltage)
      });
    }
    this.firePosition += this.xDelta;
    return this.lastVoltage = voltage;
  };

  Oscilloscope.prototype.drawThreshold = function() {
    var bbox, path, threshold, translatedThreshold, x, _i, _ref, _ref1, _ref2, _ref3;
    if (this.thresholdLine) {
      this.thresholdLine.remove();
    }
    if ((threshold = (_ref = this.neuron) != null ? (_ref1 = _ref.properties) != null ? (_ref2 = _ref1.threshold) != null ? _ref2.value : void 0 : void 0 : void 0)) {
      bbox = this.screen.getBBox();
      translatedThreshold = bbox.y + this.xAxis - (threshold * this.scale);
      path = [];
      for (x = _i = 0, _ref3 = this.screenWidth; _i < _ref3; x = _i += 10) {
        path.push("M" + (bbox.x + x) + "," + translatedThreshold);
        path.push("L" + (bbox.x + x + 5) + "," + translatedThreshold);
      }
      this.thresholdLine = this.screenPath(path.join(''));
      return this.thresholdLine.toFront();
    }
  };

  Oscilloscope.prototype.attachTo = function(neuron) {
    var _this = this;
    this.neuron = neuron;
    $(this.neuron).bind('threshold.change.oscilloscope', function() {
      return _this.drawThreshold();
    });
    return this.drawThreshold();
  };

  Oscilloscope.prototype.unattach = function() {
    if (this.neuron) {
      $(this.neuron).unbind('threshold.change.oscilloscope');
    }
    this.neuron = null;
    this.voltageDisplay.remove();
    this.firePosition = 0;
    return this.drawThreshold();
  };

  return Oscilloscope;

})(neurobehavObject.Object);
