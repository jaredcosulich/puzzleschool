// Generated by CoffeeScript 1.3.3
var bubble,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

bubble = typeof exports !== "undefined" && exports !== null ? exports : provide('./bubble', {});

bubble.Bubble = (function() {

  Bubble.prototype.width = 210;

  Bubble.prototype.arrowHeight = 15;

  Bubble.prototype.arrowWidth = 20;

  Bubble.prototype.spacing = 20;

  Bubble.prototype.backgroundColor = '#49494A';

  function Bubble(_arg) {
    this.paper = _arg.paper, this.x = _arg.x, this.y = _arg.y, this.width = _arg.width, this.height = _arg.height, this.position = _arg.position, this.html = _arg.html;
    this.animateHtml = __bind(this.animateHtml, this);

    this.init();
  }

  Bubble.prototype.$ = function(selector) {
    return this.el.find(selector);
  };

  Bubble.prototype.init = function() {
    var _ref;
    this.arrowOffset = 24;
    if ((_ref = this.position) === 'left' || _ref === 'right') {
      if (this.y - this.arrowOffset < 3) {
        this.arrowOffset = this.y - 3;
      }
      if (this.y - this.arrowOffset + this.height > this.paper.height) {
        return this.arrowOffset = this.height - this.y - 3;
      }
    }
  };

  Bubble.prototype.createContainer = function() {
    var bbox;
    this.container = this.paper.set();
    this.createBase();
    this.createArrow();
    this.container.attr({
      fill: this.backgroundColor,
      stroke: 'none'
    });
    this.container.toFront();
    return bbox = this.container.getBBox();
  };

  Bubble.prototype.createBase = function() {
    var x, y;
    x = (function() {
      switch (this.position) {
        case 'right':
          return this.x + this.arrowHeight;
        case 'left':
          return this.x - this.arrowHeight - this.width;
        default:
          return this.x - this.arrowOffset;
      }
    }).call(this);
    y = (function() {
      switch (this.position) {
        case 'right':
        case 'left':
          return this.y - this.arrowOffset;
        default:
          return this.y - this.arrowHeight - this.height;
      }
    }).call(this);
    this.base = this.paper.rect(x, y, this.width, this.height, 12);
    return this.container.push(this.base);
  };

  Bubble.prototype.createArrow = function() {
    this.arrow = (function() {
      switch (this.position) {
        case 'right':
          return this.paper.path("M" + (this.x + this.arrowHeight + 2) + "," + (this.y - (this.arrowWidth / 2)) + "\nL" + this.x + "," + this.y + "\nL" + (this.x + this.arrowHeight + 2) + "," + (this.y + (this.arrowWidth / 2)));
        case 'left':
          return this.paper.path("M" + (this.x - this.arrowHeight - 2) + "," + (this.y - (this.arrowWidth / 2)) + "\nL" + this.x + "," + this.y + "\nL" + (this.x - this.arrowHeight - 2) + "," + (this.y + (this.arrowWidth / 2)));
        default:
          return this.paper.path("M" + (this.x - (this.arrowWidth / 2)) + "," + (this.y - this.arrowHeight - 2) + "\nL" + this.x + "," + this.y + "\nL" + (this.x + (this.arrowWidth / 2)) + "," + (this.y - this.arrowHeight - 2));
      }
    }).call(this);
    return this.container.push(this.arrow);
  };

  Bubble.prototype.show = function(_arg) {
    var callback, content,
      _this = this;
    content = _arg.content, callback = _arg.callback;
    if (this.container) {
      return;
    }
    this.createContainer();
    if (content) {
      content(this.container);
    } else {
      this.createHtml();
    }
    this.container.attr({
      transform: "s0,0," + this.x + "," + this.y
    });
    this.container.animate({
      transform: "s1"
    }, 100, 'linear', function() {
      if (callback) {
        return callback();
      }
    });
    this.animateHtml();
    this.visible = true;
    return this.container.toFront();
  };

  Bubble.prototype.hide = function(_arg) {
    var callback,
      _this = this;
    callback = _arg.callback;
    if (!this.container) {
      return;
    }
    this.container.animate({
      transform: "s0,0," + this.x + "," + this.y
    }, 100, 'linear', function() {
      _this.container.remove();
      _this.container = null;
      if (callback) {
        return callback();
      }
    });
    this.animateHtml(false);
    return this.visible = false;
  };

  Bubble.prototype.animateHtml = function(grow) {
    var diffHeight, diffWidth, height, heightDiff, increment, toHeight, toWidth, width, widthDiff,
      _this = this;
    if (grow == null) {
      grow = true;
    }
    if (!this.htmlContainer) {
      return;
    }
    height = parseInt(this.htmlContainer.height());
    toHeight = grow ? parseInt(this.htmlContainer.data('height')) : 0;
    if (height === toHeight) {
      return;
    }
    width = parseInt(this.htmlContainer.width());
    toWidth = grow ? parseInt(this.htmlContainer.data('width')) : 0;
    increment = grow ? 50 : -50;
    diffHeight = toHeight - height;
    diffWidth = toWidth - width;
    heightDiff = grow ? Math.min(diffHeight, increment) : Math.max(diffHeight, increment);
    widthDiff = grow ? Math.min(diffWidth, increment) : Math.max(diffWidth, increment);
    this.htmlContainer.css({
      height: height + heightDiff,
      width: width + widthDiff,
      left: this.htmlContainer.offset().left - (this.position === 'left' ? widthDiff : 0)
    });
    return setTimeout((function() {
      return _this.animateHtml(grow);
    }), 1);
  };

  Bubble.prototype.createHtml = function() {
    var bbox, height, offsetX, offsetY, padding, width;
    if (this.htmlContainer) {
      return;
    }
    this.htmlContainer = $(document.createElement('DIV'));
    this.htmlContainer.addClass('bubble_description');
    this.htmlContainer.html("<div class='description'>" + this.html + "</div>");
    bbox = this.base.getBBox();
    offsetX = this.paper.canvas.offsetLeft;
    offsetY = this.paper.canvas.offsetTop;
    padding = 12;
    this.htmlContainer.css({
      backgroundColor: this.backgroundColor,
      top: offsetY + bbox.y + padding,
      left: offsetX + (this.position === 'left' ? bbox.x + bbox.width - padding : bbox.x + padding),
      width: 0,
      height: 0
    });
    width = bbox.width - (padding * 2);
    height = bbox.height - (padding * 2);
    this.htmlContainer.data('width', width);
    this.htmlContainer.data('height', height);
    this.htmlContainer.find('.description').width(width).height(height);
    return $(document.body).append(this.htmlContainer);
  };

  return Bubble;

})();
