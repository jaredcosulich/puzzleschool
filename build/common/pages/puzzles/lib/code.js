// Generated by CoffeeScript 1.3.3
var code;

code = typeof exports !== "undefined" && exports !== null ? exports : provide('./lib/code', {});

code.ViewHelper = (function() {

  function ViewHelper(_arg) {
    this.el = _arg.el, this.completeLevel = _arg.completeLevel;
    this.initEditors();
    this.initDescription();
    this.initHints();
    this.initTests();
    this.setOutput();
  }

  ViewHelper.prototype.$ = function(selector) {
    return this.el.find(selector);
  };

  ViewHelper.prototype.initEditors = function() {
    var container, editor, editorContainer, type, _i, _len, _ref, _results,
      _this = this;
    this.editors = [];
    _ref = this.$('.editors .editor_container');
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      container = _ref[_i];
      editorContainer = $(container);
      editor = ace.edit(editorContainer.find('.editor')[0]);
      type = editorContainer.find('.type').html();
      editor.getSession().setMode("ace/mode/" + type);
      editor.getSession().on('change', function(e) {
        return _this.setOutput();
      });
      _results.push(this.editors.push(editor));
    }
    return _results;
  };

  ViewHelper.prototype.initSection = function(className) {
    var content, height, link;
    link = this.$(".links ." + className);
    content = this.$("div." + className);
    height = content.height();
    content.css({
      height: 0,
      display: 'none'
    });
    return link.bind('click', function() {
      if (content.css('display') === 'block') {
        return;
      }
      content.css({
        display: 'block'
      });
      link.addClass('selected');
      return content.animate({
        height: height,
        duration: 250,
        complete: function() {
          $(document.body).one('click', function() {
            link.removeClass('selected');
            return content.animate({
              height: 0,
              duration: 250,
              complete: function() {
                return content.css({
                  display: 'none'
                });
              }
            });
          });
          return content.bind('click', function(e) {
            return e.stop();
          });
        }
      });
    });
  };

  ViewHelper.prototype.initDescription = function() {
    return this.initSection('description');
  };

  ViewHelper.prototype.initHints = function() {
    var hint, _i, _len, _ref, _results;
    this.tests = {};
    this.initSection('hints');
    _ref = this.$('.hints .hint');
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      hint = _ref[_i];
      _results.push((function(hint) {
        return $(hint).find('.reveal').bind('click', function() {
          return $(hint).find('.hint_content').animate({
            opacity: 1,
            duration: 500
          });
        });
      })(hint));
    }
    return _results;
  };

  ViewHelper.prototype.initTests = function() {
    var frameBody, frameFind, test, _i, _len, _ref, _results,
      _this = this;
    this.initSection('tests');
    frameBody = function() {
      var frame, frameDoc;
      frame = _this.$('.output')[0];
      frameDoc = frame.contentDocument || frame.contentWindow.document;
      return $(frameDoc.body);
    };
    frameFind = function(selector) {
      return frameBody().find(selector);
    };
    _ref = this.$('.tests .test');
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      test = _ref[_i];
      _results.push((function(test) {
        return _this.tests[$(test).html()] = function() {
          try {
            return eval(unescape($(test).data('test')));
          } catch (e) {
            return alert("A test failed to run: " + e.message);
          }
        };
      })(test));
    }
    return _results;
  };

  ViewHelper.prototype.setOutput = function() {
    var allTestsPassed, editor, html, test, testElement, _i, _j, _len, _len1, _ref, _ref1, _ref2;
    _ref = this.editors;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      editor = _ref[_i];
      $(this.$('.output')[0].contentDocument.documentElement).html(editor.getValue());
    }
    allTestsPassed = true;
    _ref1 = this.tests;
    for (html in _ref1) {
      test = _ref1[html];
      _ref2 = this.$('.tests .test');
      for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
        testElement = _ref2[_j];
        if ($(testElement).html() === html) {
          if (test()) {
            $(testElement).removeClass('wrong');
            $(testElement).addClass('correct');
          } else {
            allTestsPassed = false;
            $(testElement).removeClass('correct');
            $(testElement).addClass('wrong');
          }
        }
      }
    }
    if (allTestsPassed) {
      return this.success();
    }
  };

  ViewHelper.prototype.success = function() {
    var _this = this;
    return setTimeout((function() {
      return _this.completeLevel();
    }), 50);
  };

  return ViewHelper;

})();
