// Generated by CoffeeScript 1.3.3
var soma, wings;

soma = require('soma');

wings = require('wings');

soma.chunks({
  Translations: {
    meta: function() {
      return new soma.chunks.Base({
        content: this
      });
    },
    prepare: function() {
      var _this = this;
      this.template = this.loadTemplate('/build/common/templates/translations.html');
      return this.loadData({
        url: '/api/language_scramble/translations/incomplete',
        success: function(incomplete) {
          var _ref, _ref1, _ref2, _ref3;
          _this.incomplete = incomplete;
          _this.incomplete.noTranslationCount = ((_ref = _this.incomplete.noTranslation) != null ? _ref.length : void 0) || 0;
          _this.incomplete.noBundleCount = ((_ref1 = _this.incomplete.noBundle) != null ? _ref1.length : void 0) || 0;
          _this.incomplete.notNativeVerifiedCount = ((_ref2 = _this.incomplete.notNativeVerified) != null ? _ref2.length : void 0) || 0;
          return _this.incomplete.notForeignVerifiedCount = ((_ref3 = _this.incomplete.notForeignVerified) != null ? _ref3.length : void 0) || 0;
        }
      });
    },
    build: function() {
      this.setTitle("Translations - The Puzzle School");
      return this.html = wings.renderTemplate(this.template, this.incomplete);
    }
  }
});

soma.views({
  Translations: {
    selector: '#content .translations',
    create: function() {
      $('.register_flag').hide();
      this.initShowSection();
      this.initSaveButtons();
      return this.initNoTranslation();
    },
    initShowSection: function() {
      var link, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.show_translation');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        link = _ref[_i];
        _results.push((function(link) {
          _this.registerHashChange(link.id, function() {
            return _this.showSection(link.id);
          });
          return _this.$(link).bind('click', function() {
            var _ref1, _ref2;
            location.hash = link.id;
            if ((_ref1 = link.id) === 'no_translation') {
              _this.loadNoTranslations();
            }
            if ((_ref2 = link.id) === 'no_bundle') {
              return _this.loadNoBundle();
            }
          });
        })(link));
      }
      return _results;
    },
    initSaveButtons: function() {
      var button, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.save_button');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        button = _ref[_i];
        _results.push((function(button) {
          return $(button).bind('click', function() {
            return _this.saveNewTranslation(button);
          });
        })(button));
      }
      return _results;
    },
    initNoTranslation: function() {
      var noTranslation, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.no_translations a');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        noTranslation = _ref[_i];
        _results.push((function(noTranslation) {
          return $(noTranslation).bind('click', function() {
            return _this.displayNoTranslation(noTranslation);
          });
        })(noTranslation));
      }
      return _results;
    },
    initBundles: function() {
      var bundle, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.bundles a');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        bundle = _ref[_i];
        _results.push((function(bundle) {
          return $(bundle).bind('click', function() {
            console.log(bundle);
            return _this.setBundle($(bundle).html());
          });
        })(bundle));
      }
      return _results;
    },
    showSection: function(sectionName) {
      return this.$('#translation_container')[0].className = sectionName;
    },
    saveNewTranslation: function(button) {
      var form,
        _this = this;
      form = $(button).closest('.translation_area').find('form');
      return $.ajaj({
        url: '/api/language_scramble/translations/save',
        method: 'POST',
        headers: {
          'X-CSRF-Token': this.cookies.get('_csrf', {
            raw: true
          })
        },
        data: form.data('form').dataHash(),
        success: function(data) {
          _this.data = data;
          form.find('input').val('');
          $(button).data('form-button').success();
          _this.updateIncomplete();
          if ($(button).data('callback')) {
            return _this[$(button).data('callback')]();
          }
        }
      });
    },
    loadIncompleteTranslations: function(callback) {
      var _this = this;
      return $.ajaj({
        url: '/api/language_scramble/translations/incomplete',
        method: 'GET',
        success: function(data) {
          _this.data = data;
          return callback();
        }
      });
    },
    loadBundles: function(callback) {
      var _this = this;
      return $.ajaj({
        url: '/api/language_scramble/bundles',
        method: 'GET',
        success: function(bundles) {
          _this.displayBundles(bundles);
          return callback();
        }
      });
    },
    displayBundles: function(bundles) {
      var bundle, _i, _len;
      if (!(bundles != null ? bundles.length : void 0)) {
        return;
      }
      this.$('.bundles').html('');
      for (_i = 0, _len = bundles.length; _i < _len; _i++) {
        bundle = bundles[_i];
        this.$('.bundles').append("<a>" + bundle + "</a>");
      }
      return this.initBundles();
    },
    setBundle: function(bundle) {
      console.log(bundle);
      return this.$('.bundles').closest('.translation_area').find('input[name=\'bundle\']').val(bundle);
    },
    loadNoTranslations: function() {
      var _this = this;
      return this.loadIncompleteTranslations(function() {
        return _this.displayNoTranslations();
      });
    },
    loadNoBundle: function() {
      var _this = this;
      return this.loadBundles(function() {
        return _this.loadIncompleteTranslations(function() {
          return _this.displayNoBundle();
        });
      });
    },
    updateIncomplete: function() {
      var _ref, _ref1, _ref2, _ref3;
      this.$('.no_translation_count').html("" + (((_ref = this.data.noTranslation) != null ? _ref.length : void 0) || 0));
      this.$('.no_bundle_count').html("" + (((_ref1 = this.data.noBundle) != null ? _ref1.length : void 0) || 0));
      this.$('.not_native_verified_count').html("" + (((_ref2 = this.data.notNativeVerified) != null ? _ref2.length : void 0) || 0));
      return this.$('.not_foreign_verified_count').html("" + (((_ref3 = this.data.notForeignVerified) != null ? _ref3.length : void 0) || 0));
    },
    displayNoBundle: function() {
      var _this = this;
      return $.ajaj({
        url: "/api/language_scramble/translation/" + this.data.noBundle[0],
        method: 'GET',
        success: function(translation) {
          return _this.fillInTranslationForm(_this.$('.no_bundle .form_container'), translation);
        }
      });
    },
    displayNoTranslations: function() {
      var noTranslation, _i, _len, _ref;
      if (!this.data.noTranslation) {
        return;
      }
      this.$('.no_translations').html('');
      _ref = this.data.noTranslation;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        noTranslation = _ref[_i];
        this.$('.no_translations').append("<a>" + noTranslation + "</a>");
      }
      return this.initNoTranslation();
    },
    displayNoTranslation: function(element) {
      var data, formContainer;
      formContainer = $(element).closest('.translation_area').find('.form_container');
      formContainer.css('display', 'block');
      data = JSON.parse($(element).html());
      return this.fillInTranslationForm(formContainer, data);
    },
    fillInTranslationForm: function(formContainer, data) {
      var input, _i, _len, _ref, _results;
      _ref = formContainer.find('input');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        input = _ref[_i];
        $(input).val(data[input.name]);
        if (input.name === 'noTranslation') {
          _results.push($(input).val(JSON.stringify(data)));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    }
  }
});

soma.routes({
  '/translations': function() {
    return new soma.chunks.Translations;
  }
});
