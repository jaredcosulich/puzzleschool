// Generated by CoffeeScript 1.3.3
var soma, wings,
  _this = this;

soma = require('soma');

wings = require('wings');

soma.chunks({
  Translations: {
    meta: function() {
      return new soma.chunks.Base({
        content: this
      });
    },
    prepare: function() {
      var _this = this;
      this.template = this.loadTemplate('/build/common/templates/translations.html');
      return this.loadData({
        url: '/api/language_scramble/translations/incomplete',
        success: function(incomplete) {
          var _ref, _ref1, _ref2, _ref3;
          _this.incomplete = incomplete;
          _this.incomplete.noTranslationCount = ((_ref = _this.incomplete.noTranslation) != null ? _ref.length : void 0) || 0;
          _this.incomplete.noBundleCount = ((_ref1 = _this.incomplete.noBundle) != null ? _ref1.length : void 0) || 0;
          _this.incomplete.notNativeVerifiedCount = ((_ref2 = _this.incomplete.notNativeVerified) != null ? _ref2.length : void 0) || 0;
          return _this.incomplete.notForeignVerifiedCount = ((_ref3 = _this.incomplete.notForeignVerified) != null ? _ref3.length : void 0) || 0;
        }
      });
    },
    build: function() {
      this.setTitle("Translations - The Puzzle School");
      return this.html = wings.renderTemplate(this.template, this.incomplete || {});
    }
  }
});

soma.views({
  Translations: {
    selector: '#content .translations',
    create: function() {
      var input, _i, _len, _ref, _results,
        _this = this;
      $('.register_flag').hide();
      this.initShowSection();
      this.initSaveButtons();
      this.initDatas();
      this.initVerification();
      this.initForeignNative();
      this.$('.bulk_import_button').bind('click', function() {
        return _this.loadData();
      });
      _ref = this.$('input[name=\'nativeLanguage\']');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        input = _ref[_i];
        _results.push(this.setLanguage($(input), false));
      }
      return _results;
    },
    initShowSection: function() {
      var link, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.show_translation');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        link = _ref[_i];
        _results.push((function(link) {
          _this.registerHashChange(link.id, function() {
            return _this.showSection(link.id);
          });
          return _this.$(link).bind('click', function() {
            return location.hash = link.id;
          });
        })(link));
      }
      return _results;
    },
    initSaveButtons: function() {
      var button, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.save_button');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        button = _ref[_i];
        _results.push((function(button) {
          return $(button).bind('click', function() {
            return _this.saveNewTranslation(button);
          });
        })(button));
      }
      return _results;
    },
    initDatas: function() {
      var dataLink, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.data a');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        dataLink = _ref[_i];
        _results.push((function(dataLink) {
          return $(dataLink).bind('click', function() {
            return _this.displayData(dataLink);
          });
        })(dataLink));
      }
      return _results;
    },
    initBundles: function() {
      var bundle, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.bundles a');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        bundle = _ref[_i];
        _results.push((function(bundle) {
          return $(bundle).bind('click', function() {
            return _this.setBundle($(bundle).html());
          });
        })(bundle));
      }
      return _results;
    },
    initVerification: function() {
      var verifyButton, _i, _len, _ref, _results,
        _this = this;
      _ref = this.$('.verify_button');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        verifyButton = _ref[_i];
        _results.push((function(verifyButton) {
          return $(verifyButton).bind('click', function() {
            var form;
            form = $(verifyButton).closest('.form_container').find('form');
            form.find('.verification_field').val('1');
            return _this.saveNewTranslation(verifyButton);
          });
        })(verifyButton));
      }
      return _results;
    },
    initForeignNative: function() {
      var _this = this;
      this.$('input[name=\'foreignLanguage\']').bind('keypress', function(e) {
        return _this.setLanguage($(e.currentTarget), true, e.charCode);
      });
      return this.$('input[name=\'nativeLanguage\']').bind('keypress', function(e) {
        return _this.setLanguage($(e.currentTarget), false, e.charCode);
      });
    },
    setLanguage: function(input, foreign, charCode) {
      var language, upperCaseLanguage;
      if (charCode == null) {
        charCode = null;
      }
      language = (input.val() || '') + (String.fromCharCode(charCode) || '');
      if (language.length) {
        upperCaseLanguage = language[0].toUpperCase() + language.slice(1);
        return input.closest('form').find("span." + (foreign ? 'foreign' : 'native') + "Language").html(upperCaseLanguage);
      }
    },
    showSection: function(sectionName) {
      this.$('#translation_container')[0].className = sectionName;
      if (sectionName === 'no_translation') {
        this.loadNoTranslations();
      }
      if (sectionName === 'no_bundle') {
        this.loadNoBundle();
      }
      if (sectionName === 'not_native_verified') {
        this.loadNotNativeVerified();
      }
      if (sectionName === 'not_foreign_verified') {
        this.loadNotForeignVerified();
      }
      if (sectionName === 'bundle_list') {
        return this.loadBundleList();
      }
    },
    saveNewTranslation: function(button) {
      var dataHash, form, _ref, _ref1, _ref2,
        _this = this;
      form = $(button).closest('.form_container').find('form');
      dataHash = form.data('form').dataHash();
      this.nativeLanguage = dataHash.nativeLanguage;
      this.foreignLanguage = dataHash.foreignLanguage;
      if ((_ref = dataHash.bundle) != null ? _ref.length : void 0) {
        this.bundle = dataHash.bundle;
      }
      if ((_ref1 = dataHash.bundleDescription) != null ? _ref1.length : void 0) {
        this.bundleDescription = dataHash.bundleDescription;
      }
      if ((_ref2 = dataHash.bundleNextLevels) != null ? _ref2.length : void 0) {
        this.bundleNextLevels = dataHash.bundleNextLevels;
      }
      return $.ajaj({
        url: '/api/language_scramble/translations/save',
        method: 'POST',
        headers: {
          'X-CSRF-Token': this.cookies.get('_csrf', {
            raw: true
          })
        },
        data: dataHash,
        success: function(data) {
          _this.data = data;
          _this.clearForm(form);
          $(button).data('form-button').success();
          _this.updateIncomplete();
          if ($(button).data('callback')) {
            return _this[$(button).data('callback')]();
          }
        },
        failure: function() {
          return _this.saveNewTranslation(button);
        }
      });
    },
    clearForm: function(form) {
      var foreignLanguage, nativeLanguage;
      form.find('input').val('');
      nativeLanguage = form.find('input[name=\'nativeLanguage\']');
      nativeLanguage.val(this.nativeLanguage);
      this.setLanguage(nativeLanguage, false);
      foreignLanguage = form.find('input[name=\'foreignLanguage\']');
      foreignLanguage.val(this.foreignLanguage);
      this.setLanguage(foreignLanguage, true);
      form.find('input[name=\'bundle\']').val(this.bundle);
      form.find('input[name=\'bundleDescription\']').val(this.bundleDescription);
      return form.find('input[name=\'bundleNextLevels\']').val(this.bundleNextLevels);
    },
    loadIncompleteTranslations: function(callback) {
      var _this = this;
      return $.ajaj({
        url: '/api/language_scramble/translations/incomplete',
        method: 'GET',
        success: function(data) {
          _this.data = data;
          return callback();
        }
      });
    },
    getBundleList: function(callback) {
      var _this = this;
      return $.ajaj({
        url: '/api/language_scramble/bundles',
        method: 'GET',
        success: function(bundles) {
          return callback(bundles);
        }
      });
    },
    getBundle: function(name, callback) {
      var _this = this;
      return $.ajaj({
        url: "/api/language_scramble/bundle/" + name,
        method: 'GET',
        success: function(bundle) {
          return callback(bundle);
        }
      });
    },
    loadBundles: function(callback) {
      var _this = this;
      return this.getBundleList(function(bundles) {
        _this.displayBundles(bundles);
        return callback();
      });
    },
    loadBundleList: function() {
      var _this = this;
      return this.getBundleList(function(bundles) {
        return _this.displayBundleList(bundles);
      });
    },
    displayBundleList: function(bundles) {
      var bundle, dataArea, form, translationArea, _i, _len, _results,
        _this = this;
      if (!(bundles != null ? bundles.length : void 0)) {
        return;
      }
      dataArea = this.$('#translation_container .bundle_list .bundle_list');
      translationArea = dataArea.closest('.translation_area');
      form = translationArea.find('.form_container');
      form.hide();
      dataArea.html('');
      _results = [];
      for (_i = 0, _len = bundles.length; _i < _len; _i++) {
        bundle = bundles[_i];
        _results.push((function(bundle) {
          var bundleLink;
          bundleLink = $(document.createElement('A'));
          bundleLink.html(bundle);
          bundleLink.bind('click', function() {
            _this.latestBundle = bundle;
            return _this.showTranslations(bundleLink.html());
          });
          return dataArea.append(bundleLink);
        })(bundle));
      }
      return _results;
    },
    showTranslations: function(bundle) {
      var bundleDataArea, form, translationArea,
        _this = this;
      bundleDataArea = this.$('#translation_container .bundle_list .bundle_data');
      translationArea = bundleDataArea.closest('.translation_area');
      form = translationArea.find('.form_container');
      form.hide();
      return this.getBundle(bundle, function(bundleData) {
        var translationId, _i, _len, _ref, _results;
        _this.bundle = bundleData.name;
        _this.bundleDescription = bundleData.description;
        _this.bundleNextLevels = JSON.stringify(bundleData.nextLevels);
        bundleDataArea.show();
        bundleDataArea.html('');
        _ref = bundleData.translations;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          translationId = _ref[_i];
          _results.push((function(translationId) {
            var translationLink;
            translationLink = $(document.createElement('A'));
            translationLink.html(translationId);
            translationLink.bind('click', function() {
              bundleDataArea.hide();
              form.show();
              return _this.displayTranslation(translationArea, translationId);
            });
            return bundleDataArea.append(translationLink);
          })(translationId));
        }
        return _results;
      });
    },
    backBundleList: function() {
      if (this.latestBundle) {
        return this.showTranslations(this.latestBundle);
      } else {
        return this.loadBundleList();
      }
    },
    displayBundles: function(bundles) {
      var bundle, dataArea, _i, _len;
      if (!(bundles != null ? bundles.length : void 0)) {
        return;
      }
      dataArea = this.$('#translation_container .no_bundle .bundles');
      dataArea.html('');
      for (_i = 0, _len = bundles.length; _i < _len; _i++) {
        bundle = bundles[_i];
        dataArea.append("<a>" + (bundle.split(/\//)[1].replace(/_/g, ' ')) + "</a>");
      }
      return this.initBundles();
    },
    setBundle: function(bundle) {
      return this.$('#translation_container .no_bundle input[name=\'bundle\']').val(bundle);
    },
    loadNoTranslations: function() {
      var _this = this;
      return this.loadIncompleteTranslations(function() {
        return _this.displayNoTranslations();
      });
    },
    loadNoBundle: function() {
      var _this = this;
      return this.loadBundles(function() {
        return _this.loadIncompleteTranslations(function() {
          var _ref;
          if ((_ref = _this.data.noBundle) != null ? _ref.length : void 0) {
            return _this.displayTranslation(_this.$('#translation_container .no_bundle'), _this.data.noBundle[0]);
          }
        });
      });
    },
    loadNotNativeVerified: function() {
      var _this = this;
      return this.loadIncompleteTranslations(function() {
        return _this.displayNotNativeVerifieds();
      });
    },
    loadNotForeignVerified: function() {
      var _this = this;
      return this.loadIncompleteTranslations(function() {
        return _this.displayNotForeignVerifieds();
      });
    },
    updateIncomplete: function() {
      var _ref, _ref1, _ref2, _ref3;
      this.$('.no_translation_count').html("" + (((_ref = this.data.noTranslation) != null ? _ref.length : void 0) || 0));
      this.$('.no_bundle_count').html("" + (((_ref1 = this.data.noBundle) != null ? _ref1.length : void 0) || 0));
      this.$('.not_native_verified_count').html("" + (((_ref2 = this.data.notNativeVerified) != null ? _ref2.length : void 0) || 0));
      return this.$('.not_foreign_verified_count').html("" + (((_ref3 = this.data.notForeignVerified) != null ? _ref3.length : void 0) || 0));
    },
    displayTranslation: function(area, id) {
      var _this = this;
      return $.ajaj({
        url: "/api/language_scramble/translation/" + id,
        method: 'GET',
        success: function(translation) {
          return _this.fillInTranslationForm(area.find('.form_container'), translation);
        }
      });
    },
    displayNoTranslations: function() {
      var dataArea, noTranslation, _i, _len, _ref;
      if (!this.data.noTranslation) {
        return;
      }
      dataArea = this.$('#translation_container .no_translation .data');
      dataArea.html('');
      _ref = this.data.noTranslation;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        noTranslation = _ref[_i];
        dataArea.append("<a>" + noTranslation + "</a>");
      }
      this.initDatas();
      return this.displayData(dataArea.find('a')[0]);
    },
    displayNotNativeVerifieds: function() {
      var dataArea, notVerified, _i, _len, _ref;
      dataArea = this.$('#translation_container .not_native_verified .data');
      dataArea.html('');
      _ref = this.data.notNativeVerified;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        notVerified = _ref[_i];
        dataArea.append("<a>" + notVerified + "</a>");
      }
      this.initDatas();
      return this.displayData(dataArea.find('a')[0]);
    },
    displayNotForeignVerifieds: function() {
      var dataArea, notVerified, _i, _len, _ref;
      dataArea = this.$('#translation_container .not_foreign_verified .data');
      dataArea.html('');
      _ref = this.data.notForeignVerified;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        notVerified = _ref[_i];
        dataArea.append("<a>" + notVerified + "</a>");
      }
      this.initDatas();
      return this.displayData(dataArea.find('a')[0]);
    },
    displayData: function(element) {
      var area, data, formContainer, html;
      area = $(element).closest('.translation_area');
      formContainer = area.find('.form_container');
      if ((html = $(element).html()).indexOf('{') === 0) {
        data = JSON.parse(html);
        return this.fillInTranslationForm(formContainer, data);
      } else {
        return this.displayTranslation(area, html);
      }
    },
    fillInTranslationForm: function(formContainer, data) {
      var input, _i, _len, _ref, _results;
      _ref = formContainer.find('input');
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        input = _ref[_i];
        $(input).val(data[input.name] || '');
        if (input.name === 'noTranslation') {
          $(input).val(JSON.stringify(data));
        }
        if (input.name === 'nativeLanguage' && !data.nativeLanguage) {
          $(input).val(this.nativeLanguage);
          this.setLanguage($(input), false);
        }
        if (input.name === 'foreignLanguage' && !data.foreignLanguage) {
          $(input).val(this.foreignLanguage);
          this.setLanguage($(input), true);
        }
        if (input.name === 'bundle' && !data.bundle) {
          $(input).val(this.bundle);
        }
        if (input.name === 'bundleDescription' && !data.bundleDescription) {
          $(input).val(this.bundleDescription);
        }
        if (input.name === 'bundleNextLevels' && !data.bundleNextLevels) {
          _results.push($(input).val(this.bundleNextLevels));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    },
    loadData: function() {
      var bundle, languages, level, translation, _i, _len, _ref;
      this.dataToLoad = [];
      eval(this.$('.bulk textarea').val());
      for (languages in data) {
        for (level in data[languages].levels) {
          bundle = data[languages].levels[level];
          _ref = bundle.data;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            translation = _ref[_i];
            this.dataToLoad.push({
              nativeLanguage: languages.split('_')[0],
              foreignLanguage: languages.split('_')[1],
              bundle: bundle.title,
              bundleDescription: bundle.subtitle,
              bundleNextLevels: JSON.stringify(bundle.nextLevels),
              "native": translation["native"],
              foreign: translation.foreign,
              nativeSentence: translation.nativeSentence,
              foreignSentence: translation.foreignSentence
            });
          }
        }
      }
      return this.pushLoadedData();
    },
    pushLoadedData: function() {
      var formContainer, _ref;
      if (!((_ref = this.dataToLoad) != null ? _ref.length : void 0)) {
        this.$('.bulk textarea').val('');
        this.$('.bulk_import_button').data('form-button').success();
        return;
      }
      formContainer = this.$('#translation_container .new_translation .form_container');
      this.fillInTranslationForm(formContainer, this.dataToLoad.pop());
      return this.$('#translation_container .new_translation .save_button').trigger('click');
    }
  }
});

soma.routes({
  '/translations': function() {
    return new soma.chunks.Translations;
  }
});
