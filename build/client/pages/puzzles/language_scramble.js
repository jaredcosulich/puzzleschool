// Generated by CoffeeScript 1.3.1
var soma, wings;

soma = require('soma');

wings = require('wings');

soma.chunks({
  LanguageScramble: {
    meta: function() {
      return new soma.chunks.Base({
        content: this
      });
    },
    prepare: function(_arg) {
      var _this = this;
      this.languages = _arg.languages, this.levelName = _arg.levelName;
      this.template = this.loadTemplate('/build/client/templates/puzzles/language_scramble.html');
      this.loadScript('/build/client/pages/puzzles/language_scramble.js');
      this.loadScript('/build/client/pages/puzzles/lib/language_scramble.js');
      this.loadStylesheet('/build/client/css/puzzles/language_scramble.css');
      this.puzzleData = {
        levels: {}
      };
      if (this.cookies.get('user')) {
        return this.loadData({
          url: '/api/puzzles/language_scramble',
          success: function(data) {
            var level, levelInfo, levelName, _ref, _results;
            if (data.puzzle != null) {
              _this.puzzleData = data.puzzle;
              _ref = _this.puzzleData.levels;
              _results = [];
              for (levelName in _ref) {
                levelInfo = _ref[levelName];
                languages = levelName.split(/\//)[0];
                level = levelName.split(/\//)[1];
                if (!_this.puzzleData.levels[languages]) {
                  _this.puzzleData.levels[languages] = {};
                }
                _this.puzzleData.levels[languages][level] = levelInfo;
                _results.push(delete _this.puzzleData.levels[levelName]);
              }
              return _results;
            }
          }
        });
      }
    },
    build: function() {
      var languageScramble;
      languageScramble = require('./lib/language_scramble');
      if (!(this.languages && this.languages.length)) {
        this.languages = this.puzzleData.lastLanguages || 'english_italian';
      }
      if (!(this.levelName && this.levelName.length)) {
        this.levelName = this.puzzleData.lastLevelPlayed || 'top10words';
      }
      if (!this.puzzleData.levels[this.languages]) {
        this.puzzleData.levels[this.languages] = {};
      }
      this.chunkHelper = new languageScramble.ChunkHelper(this.languages, this.levelName);
      return this.html = wings.renderTemplate(this.template, {
        puzzleData: JSON.stringify(this.puzzleData),
        languages: this.languages,
        displayLanguages: this.chunkHelper.displayLanguages(),
        title: this.chunkHelper.level.title,
        subtitle: this.chunkHelper.level.subtitle,
        data: this.chunkHelper.level.data,
        levelName: this.levelName,
        allLevels: this.chunkHelper.allLevels()
      });
    }
  }
});

soma.views({
  LanguageScramble: {
    selector: '#content .language_scramble',
    create: function() {
      var languageScramble,
        _this = this;
      languageScramble = require('./lib/language_scramble');
      this.puzzleData = JSON.parse(this.el.data('puzzle_data'));
      this.languages = this.el.data('languages');
      this.levelName = this.el.data('level_name');
      this.viewHelper = new languageScramble.ViewHelper({
        el: $(this.selector),
        puzzleData: this.puzzleData,
        languages: this.languages,
        go: this.go,
        saveProgress: function(puzzleProgress) {
          var answerCount, languages, levelInfo, levelName, levelUpdates, levels, puzzleUpdates, _ref, _ref1;
          if (_this.cookies.get('user')) {
            puzzleUpdates = _this.getUpdates(puzzleProgress);
            if (!puzzleUpdates) {
              return;
            }
            levelUpdates = {};
            _ref = puzzleUpdates.levels;
            for (languages in _ref) {
              levels = _ref[languages];
              for (levelName in levels) {
                levelInfo = levels[levelName];
                levelUpdates["" + languages + "/" + levelName] = levelInfo;
              }
            }
            delete puzzleUpdates.levels;
            console.log("UPDATES", JSON.stringify(puzzleUpdates), JSON.stringify(levelUpdates));
            return $.ajaj({
              url: "/api/puzzles/language_scramble/update",
              method: 'POST',
              data: {
                puzzleUpdates: puzzleUpdates,
                levelUpdates: levelUpdates
              },
              success: function() {
                return _this.puzzleData = puzzleProgress;
              }
            });
          } else if (puzzleProgress.levels) {
            answerCount = 0;
            _ref1 = puzzleProgress.levels;
            for (languages in _ref1) {
              levels = _ref1[languages];
              for (levelName in levels) {
                levelInfo = levels[levelName];
                answerCount += Object.keys(levelInfo).length;
              }
            }
            if (answerCount > 15) {
              return $(window).bind('beforeunload', function() {
                return 'If you leave this page you\'ll lose your progress on this level. You can save your progress above.';
              });
            }
          }
        }
      });
      this.viewHelper.setLevel(this.levelName);
      this.viewHelper.bindWindow();
      this.viewHelper.bindKeyPress();
      return this.viewHelper.newScramble();
    },
    compareItem: function(current, original) {
      if (!original) {
        return current;
      }
      if (typeof current === 'object') {
        return this.compareHashes(current, original);
      } else if (Array.isArray(current)) {
        return this.compareArrays(current, original);
      } else {
        if (current !== original) {
          return current;
        }
      }
    },
    compareHashes: function(current, original) {
      var diff, diffValue, key, value;
      diff = {};
      for (key in current) {
        value = current[key];
        diffValue = this.compareItem(value, original[key]);
        if (diffValue != null) {
          diff[key] = diffValue;
        }
      }
      if (Object.keys(diff).length > 0) {
        return diff;
      }
    },
    compareArrays: function(current, original) {
      var diff, diffValue, index, item, _i, _len;
      diff = [];
      for (index = _i = 0, _len = current.length; _i < _len; index = ++_i) {
        item = current[index];
        diffValue = this.compareItem(item, original[index]);
        if (diffValue != null) {
          diff.push(diffValue);
        }
      }
      if (diff.length > 0) {
        return diff;
      }
    },
    getUpdates: function(progress) {
      return this.compareHashes(progress, this.puzzleData);
    }
  }
});

soma.routes({
  '/puzzles/language_scramble': function() {
    return new soma.chunks.LanguageScramble;
  },
  '/puzzles/language_scramble/:languages': function(languages) {
    return new soma.chunks.LanguageScramble({
      languages: languages
    });
  },
  '/puzzles/language_scramble/:languages/:levelName': function(languages, levelName) {
    return new soma.chunks.LanguageScramble({
      languages: languages,
      levelName: levelName
    });
  }
});
